{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const timeout = function(fn, s) {\r\n  return new Promise(resolve => setTimeout(() => resolve(fn()), s))\r\n}\r\n\r\n/**\r\n * Queue for on_demand requests\r\n */\r\nclass Queue {\r\n  constructor() {\r\n    this.stack = []\r\n    this.executing = null\r\n  }\r\n\r\n  /**\r\n   * Add function to stack and execute\r\n   * Important: Function is assumed to be promisified\r\n   */\r\n  delay(fn, delay, timer, add = 'push') {\r\n    return new Promise(resolve => {\r\n      const modFn = this.modFunction(fn, delay, timer, resolve)\r\n\r\n      // Insert AFTER currently active task, so the current one would only\r\n      // remove itself after finishing\r\n      if (this.stack[0] && add === 'unshift') {\r\n        this.stack.splice(1, 0, modFn)\r\n      } else {\r\n        this.stack[add](modFn)\r\n      }\r\n      this.run()\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Generate function with timeout and waterfall functionality\r\n   */\r\n  modFunction(fn, delay, timer, resolve) {\r\n    return async() => {\r\n      const runFunction = new Promise(res => {\r\n        timeout(fn, delay).then(data => {\r\n          resolve(data)\r\n          res()\r\n        })\r\n        // Purge function if it doesn't resolve in time\r\n        setTimeout(() => {\r\n          resolve()\r\n          res()\r\n        }, timer)\r\n      })\r\n\r\n      await runFunction\r\n\r\n      // Trigger next function if available\r\n      this.stack.shift()\r\n      if (this.stack[0]) {\r\n        this.executing = true\r\n        this.stack[0]()\r\n      } else {\r\n        this.executing = false\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If nothing is queued, start waterfall, otherwise expect waterfall to be\r\n   * in progress\r\n   */\r\n  run() {\r\n    if (!this.executing) {\r\n      this.executing = true\r\n      this.stack[0]()\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = new Queue()\r\n"],"names":["timeout","fn","s","Promise","setTimeout","resolve","Queue","stack","executing","delay","timer","add","modFn","modFunction","splice","run","then","data","runFunction","shift","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,UAAU,SAAVA,OAAU,CAASC,EAAT,EAAaC,CAAb,EAAgB;SACvB,IAAIC,OAAJ,CAAY;WAAWC,WAAW;aAAMC,QAAQJ,IAAR,CAAN;KAAX,EAAgCC,CAAhC,CAAX;GAAZ,CAAP;CADF;IAOMI;mBACU;;SACPC,KAAL,GAAa,EAAb;SACKC,SAAL,GAAiB,IAAjB;;;;0BAOIP,IAAIQ,QAAOC,OAAqB;;UAAdC,GAAc,uEAAR,MAAQ;aAC7B,IAAIR,OAAJ,CAAY,mBAAW;YACtBS,QAAQ,MAAKC,WAAL,CAAiBZ,EAAjB,EAAqBQ,MAArB,EAA4BC,KAA5B,EAAmCL,OAAnC,CAAd;YAII,MAAKE,KAAL,CAAW,CAAX,KAAiBI,QAAQ,SAA7B,EAAwC;gBACjCJ,KAAL,CAAWO,MAAX,CAAkB,CAAlB,EAAqB,CAArB,EAAwBF,KAAxB;SADF,MAEO;gBACAL,KAAL,CAAWI,GAAX,EAAgBC,KAAhB;;cAEGG,GAAL;OAVK,CAAP;;;;gCAiBUd,IAAIQ,OAAOC,OAAOL,SAAS;;sDAC9B;;;;;;2BAAA,GACe,IAAIF,OAAJ,CAAY,eAAO;0BAC7BF,EAAR,EAAYQ,KAAZ,EAAmBO,IAAnB,CAAwB,gBAAQ;4BACtBC,IAAR;;mBADF;6BAKW,YAAM;;;mBAAjB,EAGGP,KAHH;iBANkB,CADf;;uBAaCQ,WAbD;;uBAgBAX,KAAL,CAAWY,KAAX;oBACI,OAAKZ,KAAL,CAAW,CAAX,CAAJ,EAAmB;yBACZC,SAAL,GAAiB,IAAjB;yBACKD,KAAL,CAAW,CAAX;iBAFF,MAGO;yBACAC,SAAL,GAAiB,KAAjB;;;;;;;;OArBJ;;;;0BA8BI;UACA,CAAC,KAAKA,SAAV,EAAqB;aACdA,SAAL,GAAiB,IAAjB;aACKD,KAAL,CAAW,CAAX;;;;;;AAKNa,OAAOC,OAAP,GAAiB,IAAIf,KAAJ,EAAjB"}